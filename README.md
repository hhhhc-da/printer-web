# 一. 使用说明

该网站主要用于社团成员打印 pdf、图片等资料，设计目的是为了社团成员能够更加方便快捷的使用打印机完成打印功能，近期已经支持自定义打印行为

在校园网中使用需要绑定公网 IP 和局域网 IP，对应关系如下

192.168.1.72:80 是我们的内网前端服务

192.168.1.72:81 是我们的后端服务

# 二. 使用部分

### **2.1 系统地址**

我们配置了两种访问方式，一种通过校园网访问，另一种通过实验室网络访问，这两种访问方式访问到的页面、所使用的功能都是一样的，使得大家只要在学校里，连接上校园网就能够打印所需的资料，方便快捷

### **2.2 主体部分**

#### **2.2.1 登陆页面**

点击进入之后就是一个登录页面

![1765629644299](./Images/README/1765629644299.png)

可以创建自己的账号密码

主页也有对应的跳转按钮，可以直接进入对应的地方

![image](./Images/README/home.png)

同时我们取消了测试页面，不再由 WSGI 服务器管理 Home 页

#### **2.2.2 数据库**

如果想要创建自己的账号和密码，需要在数据库中自行添加

PgSQL 的端口在 5432，Redis 的端口在 6379，都可以局域网访问

#### **2.2.3 打印主页**

登录进去之后就是我们的打印页面

![1765629778028](./Images/README/1765629778028.png)

这个页面主要展示了打印机的数量以及状态

如果需要打印资料，则点击上传文件即可(或将文件拖到指定区域)

#### **2.2.4 自定义打印页面**

点击上方按钮自定义打印，就会进入到自定义打印页面

设计初衷：该打印系统内部打印命令只支持若干格式的资料进行打印，因此，如果用户有打印其他格式资料的需求，可以使用自定义打印，自己编写相应的打印命令进行打印

具体页面内容如图所示，用户可在输入框中写入命令，并且在下方输入框中写入自定义的打印资料的格式，点击保存修改，就完成了自定义命令，就能够打印自己想要打印的格式的资料了

除此之外，我们还在页面右侧添加了使用指南

![1765629836911](./Images/README/1765629836911.png)

用户可以根据此使用指南来进行命令的编写

但是需要注意，没有删除功能

自定义并且保存成功的文件，会一直在该文件夹下

#### **2.2.5 信息展示部分**

文件上传之后，在显示区域可以看见并检查是否上传成功(有取消功能)

随后，我们在下边打印机设置中，设置一些打印必须的参数

如：选择打印机、打印份数、打印模式、打印方向

参数设置完毕之后，即可提交打印任务，或选择清空选择

提交打印任务之后，打印进程可在显示区域查看

如果有打印任务正在打印，则会在此告知，如果没有打印任务，则你上传的文件就会直接打印

同时，如果打印任务排队时间过长(5分钟)，则会被清空，注意：只有打印完的任务或者打印失败的任务会被手动清除掉

点击刷新按钮，会获得最新的打印进度

# 三. 维护部分

### **3.1   后端服务**

#### **3.1.1 进入小机器**

我们进入小机器，我们主要是使用微软自带的 mstsc 远程桌面连接服务，当然也可以使用 ssh 服务

我们所有内容都存储在 D 盘内

所有的前端页面都在 Vue 文件夹中，后端是 Python 文件夹，而前端 HTML 的挂载使用的是 Nginx，其他的文件都已经默认配好，不需要动

小机器每次开机都是会执行 Schedule 任务，在 Nanoka 文件夹中的批处理命令会在开机后自动执行，帮我们顺序的打开

![1765629987925](./Images/README/1765629987925.png)

可以看出它按顺序开启 Redis、Python 后端服务器、Nginx 负载均衡服务器、OpenList 文件服务器

#### **3.1.2 小机器的文件服务器**

你可能不知道 OpenList 服务器是干什么的，我们直接访问 192.168.1.72:5244 就可以访问到

![1765630029479](./Images/README/1765630029479.png)

这个就是一个便捷的文件服务器，可以轻松的向 D 盘收发文件

#### **3.1.3 VSCode 修改 Vue、Python 代码**

之后就是进入 VSCode 进行修改，我们推荐使用 VSCode 修改 Vue 和 Python 代码

NanokaAPP 就是我们的后端测试界面，也就是 192.168.1.72:81 的开始界面，也是我们的前端页面的 Home 目录页，一般用于测试后端服务是否畅通

能看到这个界面说明后端 Python 服务器没有问题，因为它本身就是 Flask 服务器的 @app.route("/") 应该展示的内容

至于前端就直接去 Service、ServicePublicIP 进行修改之后编译就可以了

编译命令是 npm run build，测试代码是 npm run dev，一般会使用 5173 端口所以不要使用这个端口进行任何操作

#### **3.1.4 使用 Visual Studio 修改 C# 程序**

这里是我们的基本打印程序，也就是最后的执行打印操作的地方，我们构建了一个 Printer.exe 专门用于控制图片序列的连续打印操作

Python 主要用于处理 pdf 格式文件转换成图片序列的内容

之后把所有文件缓存到 Queue 这个文件夹，里面有 1、2 两个文件夹分别表示两个打印机 ID，也就是打印机 ID 不能随便取，必须是这样顺序存储的，在数据库中添加新的打印机的时候一定要保证 ID 的正确性，同时技术器是从 1 开始的，不能从 0 开始否则我们会认为这时候打印机不可用（前端处理逻辑）

这里一定要做好对应工作，这个是直接展示的

而具体怎么使用都是通过 Windows 的驱动程序实现的查询和缓冲队列

可以在设备管理器看到以下内容

![1765630099118](./Images/README/1765630099118.png)

一定一定要保证这两个名字是完全相同的，不然会出现 C# 程序找不到指定的系统驱动，C# 就是根据这个名字进行的查找

#### **3.1.5 高级操作**

这个就是打印所有图片序列的函数，同时这里也可以进行其他操作，比如这里我设置了页边距为 0 的画布，就可以展示图片原本的状态

如果想进行一些基本的图像修改，可以在先前的 Python 中进行处理会更加方便

可以看出，我们是通过 YAML 文件进行的图片组织和管理，都在 {folder}/{printer\_id}/ 文件夹下，我们的图片一般都是放在 Front 文件夹内，如果打印机没有双面打印驱动，我们还可以进行适配，将双面的图片放入 Back 文件夹，其他的放在 Front 文件夹内，之后通过 C# 程序重新组织图片序列就可以实现伪双面打印

不难看出，这个 Python 程序调用了 powershell 去执行一个叫 Printer.exe 的程序，这个就是我们的 C# 程序

#### **3.1.6 系统架构**

我们使用 Redis 作为存储序列，每一个信息设置了 expire = 300 也就是 5min 过期时间，一般不会超过

而我们的后端每一次都是由一个线程去访问 Redis 查询是否有信息可以下载并执行

这个工作线程将是主要维护的内容之一，还有一个就是具体的打印函数，在上面

我们基本只需要维护这两个就可以了，不需要任何其他的架构改动
