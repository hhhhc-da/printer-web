using System;
using System.Drawing;
using System.Drawing.Printing;
using System.IO;
using Spire.Pdf;

// Printer.exe --printer "Pantum P2200NW Series" --filename C:\Users\Administrator\Downloads\workflow.png --filetype image --copies 1 --deplex 0 --route 1
// Printer.exe --printer "Pantum P2200NW Series" --filename C:\Users\Administrator\Downloads\AGI实现思路.pdf --filetype pdf --copies 2 --duplex 1 --route 0
namespace Printer
{
    internal class Program
    {
        static string printerName = string.Empty;
        static string filename = string.Empty;
        static string filetype = string.Empty;
        static int copies = 1;
        static bool duplex = false;
        static bool route = false;

        static void Main(string[] args)
        {
            // Parse command line arguments
            for (int i = 0; i < args.Length; i++)
            {
                switch (args[i])
                {
                    case "--printer":
                        if (i + 1 < args.Length) printerName = args[++i];
                        break;
                    case "--filename":
                        if (i + 1 < args.Length) filename = args[++i];
                        break;
                    case "--filetype":
                        if (i + 1 < args.Length) filetype = args[++i];
                        break;
                    case "--copies":
                        if (i + 1 < args.Length && int.TryParse(args[++i], out int c)) copies = c;
                        break;
                    case "--duplex":
                        if (i + 1 < args.Length && int.TryParse(args[++i], out int d)) duplex = d != 0;
                        break;
                    case "--route":
                        if (i + 1 < args.Length && int.TryParse(args[++i], out int r)) route = r != 0;
                        break;
                }
            }

            if (string.IsNullOrEmpty(printerName) || string.IsNullOrEmpty(filename) || string.IsNullOrEmpty(filetype))
            {
                Console.WriteLine("Missing required arguments.");
                Console.WriteLine("Usage: Printer.exe --printer <name> --filename <path> --filetype <type> --copies <n> --duplex <0|1> --route <0|1>");
                return;
            }

            if (!File.Exists(filename))
            {
                Console.WriteLine($"File not found: {filename}");
                return;
            }

            switch (filetype.ToLower())
            {
                case "image":
                    PrintImage(filename);
                    break;
                case "pdf":
                    PrintPdf(filename);
                    break;
                default:
                    Console.WriteLine($"Unsupported filetype: {filetype}");
                    break;
            }
        }

        static void PrintImage(string path)
        {
            PrintDocument pd = new PrintDocument();
            pd.PrinterSettings.PrinterName = printerName;
            pd.PrinterSettings.Copies = (short)copies;
            pd.PrinterSettings.Duplex = duplex ? Duplex.Vertical : Duplex.Simplex;
            Image img = Image.FromFile(path);
            if (route)
            {
                img.RotateFlip(RotateFlipType.Rotate90FlipNone);
            }
            pd.PrintPage += (sender, e) =>
            {
                Rectangle m = e.MarginBounds;
                e.Graphics.DrawImage(img, m);
            };
            try
            {
                pd.Print();
                Console.WriteLine("Print job sent.");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Print failed: {ex.Message}");
            }
            finally
            {
                img.Dispose();
            }
        }

        static void PrintPdf(string path)
        {
            PdfDocument doc = new PdfDocument();
            doc.LoadFromFile(path);
            doc.PrintSettings.PrinterName = printerName;
            doc.PrintSettings.Copies = copies;
            doc.PrintSettings.Duplex = duplex ? DuplexPrintMode.Vertical : DuplexPrintMode.Simplex;
            if (route)
            {
                // 旋转每一页90度
                for (int i = 0; i < doc.Pages.Count; i++)
                {
                    doc.Pages[i].Rotate = PdfPageRotateAngle.RotateAngle90;
                }
            }
            try
            {
                doc.Print();
                Console.WriteLine("Print job sent.");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Print failed: {ex.Message}");
            }
            finally
            {
                doc.Close();
            }
        }
    }
}
